// https://leetcode.com/problems/take-gifts-from-the-richest-pile/

pub struct Solution;

// Initial sol'n
// impl Solution {
//     pub fn pick_gifts(gifts: Vec<i32>, k: i32) -> i64 {
//         const MAX_VAL: i32 = 1_000_000_000;
//         const PERFECT_SQUARE_COUNT: usize = {
//             let mut l = 31_000;
//             let mut r = 32_000;
//             while l < r {
//                 let m = l + (r - l) / 2;
//                 if m * m <= MAX_VAL {
//                     l = m + 1;
//                 } else {
//                     r = m;
//                 }
//             }
//             l as usize
//         };
//         const PERFECT_SQUARES: [i32; PERFECT_SQUARE_COUNT] = {
//             let mut squares = [0; PERFECT_SQUARE_COUNT];
//             let mut i = 0;
//             while i * i <= MAX_VAL {
//                 squares[i as usize] = i * i;
//                 i += 1;
//             }
//             assert!(i == PERFECT_SQUARE_COUNT as i32);
//             squares
//         };
//         let mut heap: std::collections::BinaryHeap<i32> = gifts.into();
//         let mut prev_sqrt = PERFECT_SQUARE_COUNT - 1;
//         for _ in 0..k {
//             let Some(mut top) = heap.peek_mut() else {
//                 break;
//             };
//             let sqrt = match PERFECT_SQUARES[..=prev_sqrt].binary_search(&top) {
//                 Ok(i) => i,
//                 Err(i) => i - 1,
//             };
//             prev_sqrt = sqrt;
//             *top = sqrt as i32;
//         }
//         heap.into_iter().map(|x| x as i64).sum()
//     }
// }

// Removing negative numbers to try to see if it reduces mem usage (it didn't)
impl Solution {
    pub fn pick_gifts(gifts: Vec<i32>, k: i32) -> i64 {
        const MAX_VAL: u32 = 1_000_000_000;
        const PERFECT_SQUARE_COUNT: usize = {
            let mut l = 31_000;
            let mut r = 32_000;
            while l < r {
                let m = l + (r - l) / 2;
                if m * m <= MAX_VAL {
                    l = m + 1;
                } else {
                    r = m;
                }
            }
            l as usize
        };
        const PERFECT_SQUARES: [u32; PERFECT_SQUARE_COUNT] = {
            let mut squares = [0; PERFECT_SQUARE_COUNT];
            let mut i = 0;
            while i * i <= MAX_VAL {
                squares[i as usize] = i * i;
                i += 1;
            }
            assert!(i == PERFECT_SQUARE_COUNT as u32);
            squares
        };
        let mut heap: std::collections::BinaryHeap<i32> = gifts.into();
        let mut prev_sqrt = PERFECT_SQUARE_COUNT - 1;
        for _ in 0..k {
            let Some(mut top) = heap.peek_mut() else {
                break;
            };
            assert!(*top > 0);
            let sqrt = match PERFECT_SQUARES[..=prev_sqrt].binary_search(&(*top as u32)) {
                Ok(i) => i,
                Err(i) => i - 1,
            };
            prev_sqrt = sqrt;
            *top = sqrt as i32;
        }
        heap.into_iter().map(|x| x as i64).sum()
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    fn test(gifts: &[i32], k: i32, expected: i64) {
        assert!(gifts.len() >= 1);
        assert!(gifts.len() <= 1000);
        assert!(k >= 1);
        assert!(k <= 1000);
        for &gift in gifts {
            assert!(gift >= 1);
            assert!(gift <= 1_000_000_000);
        }
        assert_eq!(Solution::pick_gifts(gifts.to_vec(), k), expected);
    }

    #[test]
    fn ex1() {
        test(&[25, 64, 9, 4, 100], 4, 29)
    }

    #[test]
    fn ex2() {
        test(&[1, 1, 1, 1], 4, 4)
    }

    #[test]
    fn discussion_case1() {
        test(
            &[
                277447314, 118310771, 637284340, 480126814, 298991099, 942778922, 900247775,
                235716951, 410939651, 412382676, 800988470, 544186494, 995788544, 364828445,
                245142248, 884916595, 633755967, 283341357, 95538515, 47254920, 166199332,
                338804388, 673177554, 627258756, 605120786, 520807684, 67966053, 566199164,
                514795459, 466754836, 342993082, 413961206, 782932161, 936479788, 26083187,
                125196116, 466271469, 651927787, 713408922, 143430045, 817802338, 152193103,
                950432467, 33417145, 127674247, 757523702, 461462676, 266159282, 34134712,
                675727789, 292051549, 283646066, 412635621, 123941519, 369175073, 313134902,
                401301124, 661615040, 862300585, 684142965, 203520924, 799996292, 885295417,
                581665551, 581883340, 64001023, 363724811, 553397918, 592958641, 14982734,
                173326981, 974996954, 531990484, 879933541, 23572172, 684140763, 926612438,
                276872895, 356032426, 147820046, 369413297, 106646924, 658693080, 602627224,
                448452237, 848961191, 813717945, 72654432, 270071114, 612574228, 111873833,
                559098406, 80618797, 924736701, 629427828, 137719900, 521057294, 37214919,
                558588258, 902626715, 839555846, 239864938, 372932870, 103955258, 598921821,
                898011389, 759554521, 232964692, 190257414, 744837733, 712279807, 247125745,
                428458062, 216257204, 653673609, 749882117, 800254259, 471355840, 374108782,
                169609965, 289024386, 773909051, 960554006, 374235502, 587634763, 915119004,
                215599574, 232001374, 500073727, 889293620, 336870604, 137937556, 297233452,
                602474313, 713452490, 833422936, 826340142, 490238, 89423367, 708977807, 879750831,
                352274758, 331099815, 936547427, 758471680, 839707680, 347106546, 37698028,
                90805418, 656821710, 15161391, 313967079, 862588992, 123113940, 178759311,
                764348279, 295607032, 216260878, 550518710, 595575221, 371884257, 928859582,
                482206281, 95464747, 445192564, 539801284, 571125322, 892799169, 439349216,
                131756881, 86299274, 637341562, 497097959, 348032590, 186975560, 318436308,
                258814689, 674657943, 469178241, 723306024, 750258777, 307876479, 33656371,
                24594365, 897108668, 8827159, 685512611, 908021440, 289151764, 81790922, 935086547,
                709967990, 336203144, 340294856, 588245160, 701681481, 308630333, 52004499,
                841038234, 760705297, 267160621, 912050914, 953826805, 743369556, 554700494,
                150343625, 278713160, 641184510, 60223764, 843913018, 417271186, 449463941,
                301588363, 625377607, 242064221, 272159144, 335811193, 977670888, 868195580,
                572084113, 525594624, 954969164, 481907929, 760495241, 131945520, 454895422,
                402085067, 182037617, 559119982, 55066018, 248047607, 758284369, 867514208,
                512518304, 411995500, 32864329, 256076469, 87081685, 331031917, 105679248,
                885260978, 196084925, 970816672, 138169170, 469943565, 16314519, 959405910,
                809487662, 388881135, 564234187, 444426705, 133745366, 566222261, 264713415,
                536691720, 302463231, 288354574, 434024366, 463324375, 505433120, 748810513,
                995237498, 62658268, 176343057, 761464744, 952320320, 917089435, 562891986,
                383647867, 217393190, 267594929, 162296495, 237628182, 857843579, 323023608,
                847042303, 156012533, 200016926, 592359727, 268864419, 584297473, 29261114,
                194615219, 249788247, 927916901, 881147015, 774994847, 448147860, 993476616,
                948689825, 757235058, 168410058, 261293273, 814174124, 601265848, 138319669,
                946038388, 894715782, 624295329, 731441999, 180388935, 799923766, 266237773,
                562657069, 831022048, 321464193, 857493226, 931688982, 918578752, 853637994,
                761173761, 796700009, 22585925, 775179599, 494864069, 848236565, 971551925,
                909897075, 214517534, 66965450, 442425679, 180184425, 409113049, 542807979,
                416508165, 228158890, 413184208, 572538496, 564929623, 529550508, 110633924,
                136119802, 918913425, 92300082, 572099247, 12512096, 965425577, 885875796,
                959718320, 87769456, 11325177, 801953096, 260951384, 800685460, 425059237,
                483595365, 723808264, 296125603, 442867416, 370755823, 710642430, 425518671,
                277298329, 779746785, 82286377, 958342715, 818246862, 169345221, 629246541,
                260565548, 795395363, 225375085, 921274429, 48689888, 817768382, 917190889,
                57617226, 548977930, 868772763, 71978045, 744234556, 479162942, 267348924,
                483839649, 762506661, 835323846, 963138705, 817544285, 710283541, 144406453,
                644054147, 673102563, 945038573, 547271492, 310477419, 14486681, 642490235,
                158630137, 377098772, 716023047, 384377513, 394090955, 890876381, 319280760,
                538750350, 688974286, 739038427, 272202303, 143470852, 24161346, 514803857,
                866416691, 788256928, 894944132, 918508644, 214326843, 653441184, 426175347,
                364403467, 508445754, 323646943, 472846257, 149596058, 510501606, 879095129,
                317720441, 868357283, 752673818, 980409982, 356350846, 374736678, 916078219,
                684897040, 647564042, 408779867, 425053412, 621430218, 430861447, 746829255,
                961350191, 538499005, 319872279, 724326984, 874970344, 812979053, 606352530,
                905481795, 252588022, 202733076, 463130543, 232341516, 284710476, 552302039,
                179755674, 547240058, 150608729, 867288643, 641414898, 555536163, 812379611,
                966423982, 570942704, 834944685, 978471107, 543652462, 897857436, 887260919,
                695214004, 510946445, 984695040, 366913862, 278071436, 465384878, 323895513,
                489849622, 973193804, 698503361, 565566502, 56003253, 847673707, 783303982,
                208654030, 275942910, 492651616, 742357555, 73843694, 19626478, 216097394,
                641227505, 110825226, 918781893, 275257648, 852451258, 1126821, 886332016,
                937998667, 232554010, 961995328, 198645552, 663737286, 186387009, 974113951,
                710052469, 386955246, 654335896, 871638174, 287413066, 9675139, 724238392,
                705089529, 17706230, 22173814, 652373956, 984056203, 996915983, 179828234,
                892559551, 934316932, 333292204, 882702128, 253550267, 422031681, 883914447,
                536663051, 792785416, 390066780, 921528305, 380875632, 94286883, 624998518,
                463788012, 839739109, 123846469, 751072882, 26557722, 824717428, 184888287,
                15325803, 637668157, 570901433, 292640655, 378803879, 792817420, 223998469,
                934804627, 988757118, 412265324, 211321035, 342811761, 198078482, 854295461,
                192000172, 532905139, 706624030, 162292250, 656850752, 635023441, 542919803,
                437751835, 630073586, 673742096, 977694059, 924717293, 243408511, 972739792,
                2951531, 58151534, 468295685, 963589628, 649056155, 33662503, 694047302, 695401320,
                696052377, 999473447, 145543186, 539515998, 91502289, 450242140, 333192250,
                356206287, 679612919, 983680245, 672455452, 994251922, 887284683, 664780957,
                203006771, 767112284, 65994951, 364134888, 148364025, 339434173, 705472123,
                802111382, 294621390, 521888441, 516737288, 653876481, 980090564, 354963036,
                289453567, 961871881, 693596617, 83644947, 492480592, 863453423, 810295939,
                171346659, 964265539, 115614556, 550217608, 278039079, 600142438, 767538087,
                434393145, 652843943, 480812423, 452344216, 720418742, 170774551, 652273934,
                991871016, 450067064, 822792447, 135724666, 736873179, 705319595, 872854462,
                831339520, 845633512, 120715438, 627630016, 830382771, 119654932, 900574581,
                199743231, 801822993, 517841286, 315901879, 737065393, 782721199, 107382355,
                735057813, 820709580, 457165865, 281564926, 296486285, 843023052, 118797640,
                682131090, 381926163, 546618825, 886067533, 575544037, 860943355, 80241598,
                8672577, 43913800, 652650238, 15918024, 832732383, 148708216, 953863832, 131926941,
                438196121, 413458017, 841620367, 516827171, 951253969, 29042357, 336391530,
                678516945, 880251883, 150796652, 91351561, 754736501, 420950110, 691385238,
                621917477, 804774568, 241714694, 52298700, 224667834, 442833692, 982423293,
                987424188, 969050555, 29646751, 50646260, 643259807, 839683444, 428845771,
                142256255, 601583686, 785058577, 755215681, 319116372, 436685880, 434565945,
                957833793, 894798699, 586633960, 58817967, 797464862, 898538786, 478553743,
                943145297, 582397347, 156127711, 601904738, 968436514, 136487460, 691748959,
                222601794, 631953717, 180769378, 892046626, 95866298, 619067126, 504232258,
                309031846, 287624994, 271351188, 227240273, 432866700, 735132347, 9656696,
                928693538, 683285471, 925840924, 55351506, 562070896, 830917406, 835552926,
                75337639, 940816656, 11010560, 686635339, 305648132, 165899582, 829671768,
                151236017, 894037197, 817876255, 544712195, 144506935, 122961716,
            ],
            988,
            8469303,
        )
    }

    #[test]
    fn discussion_case2() {
        test(
            &[
                411042985, 697316006, 569259488, 665293106, 728558122, 395308016, 962051539,
                449602622, 225273018, 421053664, 772795795, 42557563, 640312042, 791181812,
                239411012, 610918759, 7894884, 951279693, 478806887, 792321489, 11566125,
                445499925, 164783184, 832628691, 216001498, 68086337, 621597421, 683035143,
                138851304, 999858983, 978638960, 957360800, 845854378, 339740721, 805732223,
                301257941, 948144266, 316601503, 834324760, 952034242, 485765680, 367489151,
                562273287, 443830581, 527380862, 354003764, 868621029, 285858008, 554465828,
                934261207, 326805671, 476383643, 849715786, 573608875, 356570192, 430933288,
                720102531, 360069216, 998389465, 433353834, 960876305, 811449015, 300988814,
                997136000, 748106345, 15324739, 229841322, 902721256, 976259160, 766465590,
                501357697, 808233891, 320808719, 432897238, 460174119, 793856268, 794308304,
                888513797, 919561695, 997018294, 872517844, 732758397, 139382267, 987197536,
                192080964, 512521917, 204398822, 183408531, 670587276, 993461405, 207192986,
                83676396, 933501217, 290641393, 539672160, 902963870, 543574898, 175895424,
                630556454, 917789451, 198596337, 710134838, 520718131, 130351018, 516751550,
                266412928, 466028542, 197238216, 124798889, 905882992, 58409955, 553925368,
                41052728, 754849139, 791608447, 96498420, 847746924, 801453189, 775979365,
                101433510, 948173651, 634882737, 147469850, 157994270, 604456360, 225338800,
                693732347, 385582201, 393211915, 107235426, 102866862, 404442716, 524299261,
                134876886, 360405003, 615748736, 956635493, 560785416, 218147103, 652012553,
                240280795, 819791421, 641230611, 612132184, 476730617, 647516851, 308142039,
                102486973, 150690655, 449220082, 901741894, 102594315, 804298689, 970625448,
                202387635, 770166478, 139857289, 191053305, 992821372, 738572151, 285304203,
                295950554, 850907897, 726252282, 348602857, 181617317, 478453262, 762885760,
                360811868, 586520050, 107418066, 810231588, 97005102, 425532800, 12367528,
                66900692, 202519795, 368788277, 467295402, 949869622, 266533684, 861493897,
                355296238, 994480595, 459013013, 632639412, 133044329, 352413436, 70343030,
                517236863, 652861971, 529559148, 318834519, 263079141, 411904232, 935516207,
                767239406, 63426685, 370300413, 356019633, 181482985, 96414165, 601664676,
                296441949, 491988465, 6674257, 850240442, 871498452, 666111648, 671651141,
                171469356, 919558542, 151653696, 788784252, 598942504, 609197094, 362651934,
                730271250, 798858341, 487662381, 906902772, 934112890, 744407596, 72592439,
                849616589, 418288497, 879569216, 291826753, 502745282, 304119041, 31290767,
                434303562, 921982054, 25527606, 868664232, 971790103, 489230345, 870879486,
                119499912, 141546125, 866303287, 878976557, 322745805, 353861446, 319787966,
                651560269, 167019426, 525272089, 859549346, 477477637, 7427659, 653921116,
                348581572, 974282539, 166669447, 444640945, 867049851, 28627058, 320740040,
                914163072, 191557374, 620217111, 866699502, 871487886, 168225942, 84026741,
                452237455, 928364217, 812696278, 549676604, 927295304, 486213535, 934007957,
                875127560, 991747269, 573593181, 688927535, 836051208, 148889527, 974243495,
                451141055, 881966921, 364621818, 141976346, 742897361, 603021279, 386094075,
                634451699, 180948759, 873438053, 88509922, 99771148, 260170730, 120645424,
                217135839, 513643461, 971010503, 770526142, 907624281, 702552414, 205602290,
                29752018, 851929924, 920273349, 403963200, 354132106, 283801239, 381227158,
                633412448, 271311898, 475587437, 975601692, 557477248, 804808599, 41207245,
                334503344, 937968148, 478646630, 465456593, 979273300, 908101061, 239262911,
                940678691, 812776515, 791191677, 799904975, 508692780, 15944845, 560212039,
                880241046, 640034488, 783520451, 424680812, 766159285, 859039236, 917783030,
                871413702, 361793594, 230180851, 604216769, 374617264, 315288336, 859870129,
                174739859, 190118992, 779900639, 769355033, 301815420, 214430557, 868533122,
                127535880, 378491820, 790297619, 405855516, 165730573, 324055125, 871416614,
                274519616, 763142457, 668802502, 888748004, 180060246, 928876224, 435649804,
                29735032, 716244055, 973244582, 884623533, 83382602, 883979419, 199512766,
                994944436, 419113063, 442077405, 84099164, 82540477, 726492160, 611438472,
                268399816, 575195446, 72366636, 231854163, 347907916, 797139540, 486082975,
                599032788, 769091075, 652606018, 852704099, 105368721, 829719903, 182048441,
                870274119, 962235423, 171365385, 822409839, 650252876, 631725581, 653176131,
                51915363, 938485327, 470192660, 833392364, 279356386, 229570434, 576193154,
                65367587, 529999468, 78669537, 18068075, 696647571, 52372953, 638044540, 201977712,
                183972533, 528894777, 810322059, 707105593, 213971717, 559401462, 312354436,
                617277034, 795249812, 609787046, 94106276, 161430129, 400185044, 908279151,
                585583350, 867265461, 848956981, 882019, 948880258, 665977535, 359065646,
                703912241, 332647390, 960303115, 586855316, 850391910, 242862987, 623597894,
                326194681, 13078289, 616248648, 443035222, 380149333, 76113162, 352961827,
                300601771, 887591621, 823055398, 371485122, 881226207, 107854719, 322544421,
                605683146, 160084817, 378073277, 41181728, 776600450, 15567729, 899040778,
                689247697, 641000130, 976144331, 878662449, 430009684, 9099429, 463825298,
                250674312, 881396273, 462408891, 612326918, 499316266, 315573963, 872672283,
                4532574, 188446732, 740874206, 615138293, 487808202, 577594187, 72528868,
                695666803, 833728952, 14701387, 718160936, 46955296, 856421274, 97595319,
                136755829, 422403964, 411957448, 641830807, 188179649, 788133810, 236096053,
                698907105, 588407611, 115440136, 32011245, 929674397, 43907497, 423599729,
                435271853, 876558411, 303851021, 183781062, 904357040, 408335123, 28239876,
                719874350, 342359383, 676551709, 450935265, 557047058, 215812496, 991212477,
                551781058, 871404599, 382544267, 639791865, 264206417, 727637536, 34625114,
                445816797, 528760496, 550724151, 676734411, 51210506, 899160067, 889280489,
                214724708, 363240264, 491477502, 781617792, 197612253, 609786094, 211742038,
                228020156, 38310889, 214780008, 127970607, 315317381, 813198777, 347401798,
                354282481, 786946268, 327223470, 852873245, 154494142, 193808643, 618885231,
                773704523, 445694962, 296040523, 59340167, 410799255, 856521445, 867163276,
                118660678, 812578479, 610798196, 851114616, 920707519, 985560979, 534391149,
                174275920, 850807350, 408014465, 843304903, 238343030, 440261622, 817897261,
                415698115, 138230444, 601397431, 678427635, 475197016, 948814172, 668875016,
                739529092, 873781684, 389387538, 986735913, 49398891, 690766496, 662321022,
                563508177, 244511403, 231740021, 550844436, 429042319, 522091360, 240782770,
                613929459, 782593342, 84010984, 580133049, 119227278, 164588358, 944585194,
                177404234, 325700527, 30251353, 342672830, 122180798, 140878553, 664826945,
                684663665, 567221091, 664721891, 847649906, 192953136, 586787758, 446795782,
                275321411, 14173780, 822005201, 846750288, 393453854, 147868793, 47769104,
                553058369, 232106965, 768048280, 477544930, 716251629, 658327875, 289968927,
                836994003, 447489638, 924979759, 831386055, 64393174, 806872606, 267549779,
                632804099, 285891578, 207446592, 362094292, 715264602, 112773344, 745585494,
                901250825, 287864117, 528363005, 398468678, 892443651, 315495717, 62419851,
                284394209, 748523613, 115700555, 385658281, 305660144, 209122422, 984258192,
                365656256, 249753092, 258966265, 892043565, 213952883, 201880108, 735567606,
                406360625, 130651969, 574379368, 269978892, 713822399, 181339543, 371879414,
                970310784, 419482553, 28845115, 941990857, 572926369, 718384124, 46956823,
                574079170, 465705946, 735426031, 117596781,
            ],
            631,
            2108713074,
        )
    }
}
